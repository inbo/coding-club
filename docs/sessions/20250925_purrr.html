---
layout: presentation
title: purrr-fectly functional - how to stop looping and start mapping
---

class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!-- Do not forget to adapt the presentation title in the header! -->

<!-- Adjust the presentation to the session. Focus on the challenges,
    this is not a coding tutorial.

    Note, to include figures, store the image in the `/docs/assets/images/yyyymmdd/`
    folder and use the jekyll base.url reference as done in this template
    or see https://jekyllrb.com/docs/liquid/tags/#links.
    using the scale attribute ![:scale 30%](...), you can adjust the image size.
-->

<!--  Adjust the day, month  -->
# 25 SEPTEMBER 2025

## INBO coding club

<!--  Adjust the room number and name  -->
Herman Teirlinck Building

01.17 - Clara Peeters

---
class: left, top

# Reminders

1. Did we confirm the room reservation on the _roomie_?
2. Did we start the recording?


---
class: center, middle

<!-- Create a new badge using Inkscape or other programs based on the assets/images/coding_club_badges.svg file -->
![:scale 90%]({{ site.baseurl}}/assets/images/20250925/20250925_badge_functional.png)

---
class: left, top

## Functional programming

There are 3 main programming paradigms: procedural programming, object-oriented programming and functional programming.

- Functional programming: _"wrap up for-loops in a function, and call that a function instead of using the for-loop directly"_, [R for Data Science](https://r4ds.had.co.nz/iteration.html#for-loops-vs.functionals)

There are three best practices that you should generally follow*:

- Your functions should accept at least one argument.

- Your functions should return data, or another function.

- Don’t use loops! Loops declare a procedure = procedural programming

Do you know that you are doing functional programming everytime you use the pipes (`%>%` or the new `|>` from R 4.0)?

<small> __\* Source__: blogpost [Functional Programming 101 -
A DEEP DIVE ON THE BENEFITS OF FUNCTIONAL PROGRAMMING AND WHY IT’S ACTUALLY EASIER THAN YOU THINK](https://github.com/readme/guides/functional-programming-basics).

---
class: left, top

## Functional programming and R

- R is basically a functional language: "_it lends itself to a style of problem solving centred on functions_"*.

- Functional programming in basic R: `apply()`, `lapply()`, `tapply()`.

- The [purrr](https://purrr.tidyverse.org) package provides a complete and consistent set of tools.

- The most important purrr function? `map()`!

<center>![:scale 25%]({{ site.baseurl}}/assets/images/20250925/20250925_purrr_logo.png)<br></center>


<small> __\* Source__: Nobody teaches R better than Hadley Wickham, I think. The chapter [**Functional programming**](https://adv-r.hadley.nz/fp.html#fp) from his great [Advanced R](https://adv-r.hadley.nz/index.html) book. A must read!</small>

---
class: left, top

## Functional programming: why?

But why should you use functional programming?

Are purrr's functions or apply() functions faster than loops? Not necessarily! It's just another way of programming. And it's a question of clarity: **code is easier to write and to read**.

[Bjarne Stroustrup](https://en.wikipedia.org/wiki/Bjarne_Stroustrup), the developer of C++ programming language: "_To become significantly more reliable, code must become more transparent. In particular, nested conditions and loops must be viewed with great suspicion. Complicated control flows confuse programmers. Messy code often hides bugs._""

To "forget" loops and become a functional programmer, you first need a little practice, and here we are: our purrr workout at the INBO coding _gym_.

---
class: left, top

## Functionals: the `map()` function

A **functional** is a function that takes a function as an input and returns a vector as output.

`apply()`, `lapply()`, `tapply()`, `purrr::map()`: they are all examples of **functionals**.


```r
plus_two <- function(x) x + 2
map(1:3, plus_two)
#> [[1]]
#> [1] 3
#>
#> [[2]]
#> [1] 4
#>
#> [[3]]
#> [1] 5
```

<p><center>![:scale 20%]({{ site.baseurl}}/assets/images/20250925/20250925_map.png)</center></p>
<br><small>Source: Hadley Wickham, https://adv-r.hadley.nz/functionals.html</small>

---
class: left, top

## The `map()` function

Why is `map()` called map? It refers to the mathematical concept of _map_ or [_mapping_](https://en.wikipedia.org/wiki/Map_(mathematics), which is a synonym of function, i.e. an operation that associates (maps) each element of a set with one or more elements of another set.

![:scale 20%]({{ site.baseurl}}/assets/images/20250925/20250925_Function_color_example_3.png)

<small> __\* Source__: Function_color_example_3.gif: Wvbailey. The original uploader was Wvbailey at English Wikipedia.derivative work: Zerodamage - This file was derived from: Function color example 3.gif:, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=20802095</small>


---
class: left, top

## Webinars: solve iteration problems with purrr

Watch these two great videos (pdf slides are downloadable) about the talk given by Charlotte Wickham at the useR! International R User 2017 Conference: [part 1](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr/) and [part 2](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr-ii/).

<p><center>![:scale 90%]({{ site.baseurl}}/assets/images/20250925/20250925_webinars_CharlotteWickham.png)<br></center>


---
class: left, top

# Packages: install and load

```r
# if needed: install.packages("tidyverse")
install.packages("rgbif")
```

Load the packages:

```r
library(tidyverse)
library(rgbif)
```

---
class: center, top

![:scale 90%]({{ site.baseurl}}/assets/images/20250925/20250925_purrr_cheat_sheet.png)<br>

Download and use the [purrr cheatsheet](https://github.com/inbo/coding-club/blob/main/cheat_sheets/20250925_cheat_sheet_purrr.pdf). [Online version](https://rstudio.github.io/cheatsheets/html/purrr.html) is available as a webpage, including the downloadable pdf in other 6 languages.

---
class: left, top

## How to get started?

Check the [Each session setup](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup) to get started.

## First time coding club?

Check the [First time setup](https://inbo.github.io/coding-club/gettingstarted.html#first-time-setup) section to setup.

---
class: left, top

![:scale 100%]({{ site.baseurl}}/assets/images/coding_club_sticky_concept.png)

---
class: center, top

# Share your code during the coding session

<!-- Create a new hackmd file and replace this link (twice!) -->
Go to https://hackmd.io/w6HbM28FSnSxPOL2LtRNwg?edit and start by adding your name in section "Participants".

<iframe src="https://hackmd.io/w6HbM28FSnSxPOL2LtRNwg?edit" height="450px" width="800px"></iframe>


---
class: left, top

# Download data and code

You can download the material of today:

- automatically via `inborutils::setup_codingclub_session()`*

- manually** from GitHub folders [/data/20250925](https://github.com/inbo/coding-club/tree/master/data/20250925) and [/src/20250925](https://github.com/inbo/coding-club/tree/master/src/20250925)

<br>
<small> __\* Note__: you can use the date in "YYYYMMDD" format to download the coding club material of a specific day, e.g. run `setup_codingclub_session("20220428")` to download the coding club material of April, 28 2022. If date is omitted, i.e. `setup_codingclub_session()`, the date of today is used. For all options, check the [tutorial online](https://inbo.github.io/tutorials/tutorials/r_setup_codingclub_session/).</small>
<br>
<small> __\*\* Note__: check the getting started instructions on [how to download a single file](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup)</small>

---
class: left, top

# Data and scripts description

## Data


- [20250925_gbif_occs.csv](https://github.com/inbo/coding-club/blob/main/data/20250925/20250925_gbif_occs.csv) (for challenge 3): GBIF occurrences from 1950 to 2025 for 3 species (_Procyon lotor_, _Nasua narica_, _Muntiacus reevesis_) in some European countries (Netherlands, Austria, Estonia, Denmark).


## Scripts

- [20250925_challenges.R](https://github.com/inbo/coding-club/blob/main/src/20250925/20250925_challenges.R): R script to start with.

---
class: left, top

# Basics: `map()`

The _mantra_ of this 2 hours coding session is:

**FOR EACH** \_\_ **OF** \_\_ **APPLY FUNCTION** \_\_

<p>![:scale 60%]({{ site.baseurl}}/assets/images/20250925/20250925_map.png)</p>

---
class: left, top

# Basics: `map()`

The _mantra_ of this coding club is:

**FOR EACH** \_\_ **OF** \_\_ **APPLY FUNCTION** \_\_

<p>![:scale 70%]({{ site.baseurl}}/assets/images/20200630/20200630_map_basics.png)</p>

---
class: left, top

# Challenge 0

<p><center>![:scale 30%]({{ site.baseurl}}/assets/images/20250925/20250925_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)
```
- FOR EACH element OF `height_giraffe` APPLY FUNCTION `floor`
- FOR EACH element OF `height_giraffe` APPLY FUNCTION `as.character`

Do we need `map()`?

---
class: left, top

# Challenge 0

<p><center>![:scale 30%]({{ site.baseurl}}/assets/images/20250925/20250925_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)

# weight of 5 giraffes
weight_giraffe <- rnorm(n = 5, mean = 1192, sd = 300)

# data.frame with height and weight
df_giraffe <- tibble(height = height_giraffe,
                     weight = weight_giraffe)
```

- FOR EACH column OF `df_giraffe` APPLY FUNCTION mean
- FOR EACH column OF `df_giraffe` APPLY FUNCTION median

---
class: left, top

# The `map` strategy

So far so good. But data science is rarely so easy.

We use again our giraffes*, this time as a list:

```r
# Height of 5 giraffes
height_giraffe <- runif(n = 6, min = 4.3, max = 5.7)
# Weight of 5 giraffes
weight_giraffe <- rnorm(n = 6, mean = 1192, sd = 300)
# GPS tracker ID
gps_tracker_giraffe <- c("B0G", "TRT", "4FB", "U7H", "31L", "O9Q")
# Giraffes nicknames
nicknames_giraffe <- sample(
  c("Oberon", "Raïsa", "Dirk", "Emma", "Damiano", "Rhea")
)
# List with weight, height and GPS tracker IDs. Use nicknames as list element names.
giraffes <- tibble::tibble("weight" = weight_giraffe,
                           "height" = height_giraffe,
                           "gpsID" = gps_tracker_giraffe) %>%
  transpose %>%
  set_names(nicknames_giraffe)
giraffes
```

<small> __\* Disclaimer__: any actual names of INBO colleagues are used in a fictitious manner :-)</small>

---
class: left, top

# The `map` strategy

<p>Example: <bold>FOR EACH</bold> giraffe OF giraffes <bold>DO APPLY </bold> bmi function (weight / height^2)</p>

```r
bmi <- function(weight, height) weight / height^2
```

But:

```r
purrr::map(giraffes, bmi)
Error in `map()`:
ℹ In index: 1.
ℹ With name: Rhea.
Caused by error in `.f()`:
! argument "height" is missing, with no default
```

---
class: left, top

## The `map` strategy

1. Do it for one element
2. Turn it into a <bold>recipe</bold>
3. Use `map()` to apply it to all elements


### 1. Do it for one element

```r
oberon <- giraffes$Oberon
bmi(oberon$weight, oberon$height)
```

---
class: left, top

## The `map` strategy

### 2. Turn it into a recipe

Abstract it so that Oberon can be Damiano, Dirk or any other giraffe. How to do so? Functions, again!

Define a (anonymous) function around it:
```r
function(giraffe) bmi(giraffe$weight, giraffe$height)
```

Alternative way (see cheat sheet) in "modern R" (R 4.0 or higher):
```r
\(x) bmi(x$weight, x$height) # it works also with \(giraffe)
```

Old school, with tilde `~` and `.x` pronoun. It works perfectly, but is less readable:
```r
~ bmi(.x$weight, .x$height)
```

Or, even better: name the function! It is not anonymous anymore.
```r
bmi_giraffe <- function(giraffe) bmi(giraffe$weight, giraffe$height)
```

---
class: left, top

## The `map` strategy

### 3. Use `map()` to apply it to all elements

Via anonymous function:
```r
map(giraffes, function(x) bmi(x$weight, x$height))
```

Or if you defined the function `bmi_giraffe`:
```r
map(giraffes, bmi_giraffe)
```

Or via shortcut, new or old way:
```r
map(giraffes, \(giraffe) bmi(giraffe$weight, giraffe$height)) # or \(x)
map(giraffes, ~ bmi(.x$weight, .x$height))
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_1.png)
class: left, top

# Challenge 1

The code provided creates a data frame, `species`, with 3 species and a nested list, `data_nl`, with data from GBIF related to those `species` in The Netherlands. The occurrences are in the slot `data`. See code.

1. Use `species` column as names for `data_nl` elements instead of `taxonKey`. Hint: you can use a purrr function for it, but there could be other ways to solve it.

2. How many records for each species of `data_nl`? Return it as a list.

3. How to return it as a (named) vector of integers?

4. Bundle the `data` slots into a data.frame. Do not hard code it, use purrr.

5. It's time to apply same rgbif call for more countries. The vector with countries is provided. Create a named list, `data_countries`, with GBIF data for the 3 species in each country. In other words, `data_countries[[1]]` should be equal to the provided `data_nl` at the begin of this challenge.

6. Why doesn't the returned list have names? How to set countries as names? And how to have species instead of taxonKey as names of the nested lists (similar to 1). You should end up with something like this, for example: data_countries$NL$Procyon lotor.

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_2.png)
class: left, top

# Challenge 2

1. How many records are there for each species in each country? Return it as a list of countries where each element is a named vector of integers.

2. How many records in total?

3. The provided code creates a bar plot with the number of occurrences per year for Procyon lotor in NL. Generalize it to crete a similar plot for each species/country combination.

4. How to save all the data as csv files? In total you should have at most(!) 3 species * 4 countries = 12 files. Use the following file name format:
`"20250925_gbif_<taxonKey>_<species>_<country>.csv"` where species has the space replaced by underscore (_). For example: `"20250925_gbif_5218786_Procyon_lotor_NL.csv"`.

5. Bundle all the data slots into a data.frame. Call it `data_countries_df`. Again, do not hard code the species and countries neither, but use purrr.

---
class: left, top

# Intermezzo: purrr is more than `map()`

Yes, purrr is much more than `map()`. It is in general a very nice set of tools to work with lists (and vectors).

Example 1: how to remove NULL slots from a list?

```
a <- list(z = 1, b = NULL, c = 3)
purrr::compact(a)
$z
[1] 1

$c
[1] 3
```

Example 2: how to bind a list in a vector?

```r
purrr::list_c(a)
[1] 1 3
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3 - purrr + tidyr = power

Are you still hesitating about the potential of `purrr`? You still don't know what it can do in combination with [tidyr](https://tidyr.tidyverse.org/)! They can really make your modelling research a lot more understandable for (future) you and all your colleagues.

If everything went well, `data_countries_df` (see 2.5) should be a data.frame similar to the one saved as "20250925_gbif_occs.csv". In any case, run the provided code to load the dataframe, group it by `species` and **nest** it. What does nesting do?

```
> data_nested
# A tibble: 3 × 2
# Groups:   species [3]
  species           data
  <chr>             <list>
1 Procyon lotor     <tibble [627 × 142]>
2 Nasua nasua       <tibble [11 × 142]>
3 Muntiacus reevesi <tibble [67 × 142]>
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3 - purrr + tidyr = power

1. Add a new column called `bar_plot` where each element is a ggplot2
object containing a bar plot with the number of records per year for that species. Use the bars' color (`fill`) to distinguish the country. You can use the provided code as a starting point.

2. Save the plots as png files. The file names should be `"20250925_gbif_<species>_barplot.png"`  where `species` has the space replaced by underscore (_). For example: `20250925_gbif_Procion_lotor_barplot.png`. Hint: combine purrr with [ggplot2::ggsave()](https://ggplot2.tidyverse.org/reference/ggsave.html).

---
class: left, top

# The package of the month. Damiano's choice

[rvest](https://rvest.tidyverse.org/) helps you scrape (or harvest) data from web pages. It works nice togeher with [polite](https://dmi3kno.github.io/polite/) for scraping multiple pages.

<p><center>![:scale 90%]({{ site.baseurl}}/assets/images/20250925/20250925_rvest.png)

---
class: left, top

# Resources

- [Commented solutions](https://github.com/inbo/coding-club/blob/main/src/20250925/20250925_challenges_solutions.R) are available on GitHub. You can opt to download the solutions automatically by using `inborutils::setup_codingclub_session("20250925")`.
- Edited video recording is on [vimeo](https://vimeo.com/1125502081?share=copy). Do you know that all INBO coding club video recordings are available on our official [INBO coding club vimeo folder](https://vimeo.com/user/8605285/folder/1978815?isPrivate=false)?
- [purrr](https://purrr.tidyverse.org/) package homepage.
- [purrr cheatsheet](https://rstudio.github.io/cheatsheets/html/purrr.html) webpage
- Download the [purrr cheatsheet](https://github.com/inbo/coding-club/blob/main/cheat_sheets/20250925_cheat_sheet_purrr.pdf) from our repository.
- The [Advanced R](https://adv-r.hadley.nz/index.html) book of Hadley Wickham: the [Introduction](https://adv-r.hadley.nz/fp.html) to the chapter and the entire [chapter 9](https://adv-r.hadley.nz/functionals.html#functionals) about functional programming. This resource was extensively used to introduce the concepts and inspired some challenges.
- Well-written and complete tutorial: https://r4ds.had.co.nz/iteration.html#for-loops-vs.functionals (from 21.4 up to 21.9)
- Beautiful webinar (pdf slides are downloadable) from Charlotte Wickham: [part 1](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr/) and [part 2](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr-ii/). Introduction to `map()` and the map strategy material come from her.
- [tidyr](https://tidyr.tidyverse.org/) homepage.
- The package [rvest](https://rvest.tidyverse.org/) to harvest web pages (web scraping).

---
class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!--  Adjust the room number and name  -->
Topic: to be decided <br>
Room:  HT - 01.17 - Clara Peeters <br>
Date: **28/10/2025**, from **10:00** to **12:30** <br>
Help needed with technical setup? You are welcom from **9:45am**
