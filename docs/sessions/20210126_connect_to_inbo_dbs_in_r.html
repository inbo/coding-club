---
layout: presentation
title: Connect to INBO databases in R
---

class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!-- Do not forget to adapt the presentation title in the header! -->

<!-- Adjust the presentation to the session. Focus on the challenges,
    this is not a coding tutorial.

    Note, to include figures, store the image in the `/docs/assets/images/yyyymmdd/`
    folder and use the jekyll base.url reference as done in this template
    or see https://jekyllrb.com/docs/liquid/tags/#links.
    using the scale attribute ![:scale 30%](...), you can adjust the image size.
-->

<!--  Adjust the day, month  -->
# 26 JANUARY 2021

## INBO coding club

<!--  Adjust the room number and name  -->
Exclusively on INBOflix

---
class: center, middle

<!-- Create a new badge using Inkscape or other programs based on the assets/images/coding_club_badges.svg file -->
![:scale 90%]({{ site.baseurl}}/assets/images/20210126/20210126_badge_connect_to_inbo_db.png)

---
class: center, middle

# No VPN? No party

![:scale 90%]({{ site.baseurl}}/assets/images/20210126/20210126_vpn_inbo.png)

---
class: left, middle

## Introduction

We will explore the functionalities provided by two "made in INBO" packages and then we play with SQL and tidyverse.

1. [inbodb](https://inbo.github.io/inbodb/index.html)
2. [watina](https://inbo.github.io/watina/index.html)

---
class: left, middle

## `inbodb` package

1. Connect to any INBO database
2. Run specific queries for two INBO datbases: florabank and INBOVEG


[inbodb functions](https://inbo.github.io/inbodb/reference/index.html)

![:scale 100%]({{ site.baseurl}}/assets/images/20210126/20210126_functions_inbodb.png)

---
class: left, middle

## `watina` package

1. Connect to watina database
2. Run specific queries for watina database
3. Provide some useful helper functions

[watina functions](https://inbo.github.io/inbodb/reference/index.html)

![:scale 100%]({{ site.baseurl}}/assets/images/20210126/20210126_functions_watina.png)

---
class: left, middle

No cheatsheet, but a well-written [INBO tutorial](https://inbo.github.io/tutorials/tutorials/r_database_access/) is available, yeah!

![:scale 100%]({{ site.baseurl}}/assets/images/20210126/20210126_tutorial_INBO_database_access_in_r.png)

---
class: center, middle

### How to get started?

Check the [Each session setup](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup) to get started.

### First time coding club?

Check the [First time setup](https://inbo.github.io/coding-club/gettingstarted.html#first-time-setup) section to setup.

---
class: left, middle

![:scale 100%]({{ site.baseurl}}/assets/images/coding_club_sticky_concept.png)
<br> No yellow sticky notes online :-( We use hackmd (see next slide) but basic principle doesn't change.

---
class: center, middle

### Share your code during the coding session!

<!-- Create a new hackmd file and replace this link (twice!) -->
Go to https://hackmd.io/SEuVG7pURQmvUGVjeXOrLA?edit

<iframe src="https://hackmd.io/SEuVG7pURQmvUGVjeXOrLA?edit" height="400px" width="800px"></iframe>

---
class: left, middle

# Download data and code

Instead of downloading the files manually we have a new `inborutils` function called `setup_codingclub_session()`. If you have not used this function yet, restart your R session and update the `inborutils` package by running:

```r
if (!"remotes" %in% rownames(installed.packages())) {
  install.packages("remotes")
}
remotes::install_github("inbo/inborutils")
```

To download the coding club material of today, just run `setup_codingclub_session()`. In general, you can use the date in "YYYYMMDD" format , e.g. `setup_codingclub_session("20201027")`, to download the coding club material of October, 27. For all options, check the [tutorial online](https://inbo.github.io/tutorials/tutorials/r_setup_codingclub_session/).

Of course, you can still download [data](https://github.com/inbo/coding-club/blob/master/data/20210126/) and [scripts](https://github.com/inbo/coding-club/blob/master/src/20210126/) manually*!

<small>* __Note__: check the getting started instructions on [how to download a single file](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup)</small>

---
class: left, middle

## Challenge 0

1. Log in to INBO VPN

2. Install the required packages, by following the instructions:
  - [inbodb installation instructions](https://inbo.github.io/inbodb/#installation)
  - [watina installation instructions](https://inbo.github.io/watina/index.html#installing-testing-and-using-the-watina-package)

3. Load the required packages:
```r
library(inbodb)
library(watina)
```
4. Open connections to databases
```r
watina <- connect_watina()
inboveg <- connect_inbo_dbase("D0010_00_Cydonia")
florabank <- connect_inbo_dbase("D0021_00_userFlora")
```
5. Did you get this error: `"The 'ODBC Driver for SQL Server' is missing. Please install it or contact your system administrator."` Well, contact ICT helpdesk this afternoon, but now run this after restarting R:
```r
remotes::install_github("inbo/inbodb@sos")
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_1.png)
class: left, middle

# Challenge 1

1. Find the R connection pane of RStudio and open a view of table `tblTaxon` of florabank (D0021_00_userFlora), table `ivRecording` of INBOVEG (D0010_00_Cydonia) and table `DimChemVar` of watina (W0002_00_Watina). Tips: check [RStudio connection pane documentation](https://db.rstudio.com/rstudio/connections/#connections-pane); tables are under (default) schema `dbo`

2. Still using the RStudio connection pane, find the type of the columns of tables in 1, e.g. *char*acter, *int*eger

3. what type `bit` stands for? Tip: check e.g. column which values  are contained in column `CUURENT_IND` of table `DimChemVar` opened in 1


---
class: left, middle

# Intermezzo 1: R is lazy... so we are

Let's get the locations from watina database using watina function `get_locs(watina)`. But why do you get an error if you tyr to save them in a text format (e.g. csv)?

```r
locations <- get_locs(watina)
write_csv(locations)

> Error in write_delim(x, file, delim = ",", na = na, append = append, col_names = col_names,  :
  is.data.frame(x) is not TRUE
```

Is locations not a data.frame???

```r
class(locations)
[1] "tbl_Microsoft SQL Server" "tbl_dbi"
[3] "tbl_sql"                  "tbl_lazy"
[5] "tbl"
```

All you have is a table (`tbl`), but most of all, it's a _lazy table_... Welcome to the lazy woRld!


---
class: left, middle

# Intermezzo 1: R is lazy... so we are

![:scale 100%]({{ site.baseurl}}/assets/images/20210126/20210126_lazy_query.png)

`locations` is a SQL query, no data are really loaded on your laptop.
It is like a reference to the result of the query but the full result of the query is not brought into memory.

If you are thinking: _"are you kidding me?"_ Well, try this:


```r
locations %>% show_query()
```

IMPORTANT: to avoid bad surprises (crashes, out of memory issues), first run your queries lazily.

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_2.png)
class: left, middle

# Challenge 2

1. Using watina package and always in lazy mode:
  a. How many area codes exist in watina database?
  b. select locations from watina database with `area_codes` "KAL", "WES" or "ZAB" and depth range between 2 and 4 meters

2. Using inbodb and florabank database and still being lazy:
  a. get observations of taxon Erigeron from florabank db:

3. Usisng inbodb and inboveg connection and still being lazy:
  a.search information about survey "ABS-LIM2011":

4. How to collect the data we queried in 1, 2 and 3?

---
class: left, middle

# Intermezzo 2: do I really need to learn SQL?

If you know SQL syntax, excellent!

```r

```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, middle

# Challenge 3

Work in progress...


---
class: left, middle

# Bonus challenge

Maybe?


---
class: left, middle

## Resources

- [inbodb package documentation](https://inbo.github.io/inbodb/index.html)
- [watina package documentation](https://inbo.github.io/watina/index.html). Check also the section with very useful articles
- the wonderful INBO tutorial about [reading data from INBO databases in R](https://inbo.github.io/tutorials/tutorials/r_database_access/): a lot of useful informations in a very human language with a lot of examples. Thanks Stijn, Floris and Els!
- if you prefer webinars, here you are: a [RStudio webinar with demo](https://resources.rstudio.com/webinars/best-practices-for-working-with-databases-march-2018-edgar-ruiz?wvideo=vffitvywy6) about RStudio, R and SQL
- Very nice tutorial from Data Carpenty: [data management with SQL for ecologists](https://datacarpentry.org/sql-ecology-lesson/) lesson, especially on [queries](https://datacarpentry.org/sql-ecology-lesson/01-sql-basic-queries/index.html) and [aggregations](https://datacarpentry.org/sql-ecology-lesson/02-sql-aggregation/index.html)

---
class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!--  Adjust the room and date  -->
Room: 01.05 - Isala Van Diest(?)<br>
Date: __25/02/2021__, van 10:00 tot 12:00<br>
Subject: **read data in R** <br>
(registration announced via DG_useR@inbo.be)
