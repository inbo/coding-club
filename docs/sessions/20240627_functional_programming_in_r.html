---
layout: presentation
title: functional programming in R
---

class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!-- Do not forget to adapt the presentation title in the header! -->

<!-- Adjust the presentation to the session. Focus on the challenges,
    this is not a coding tutorial.

    Note, to include figures, store the image in the `/docs/assets/images/yyyymmdd/`
    folder and use the jekyll base.url reference as done in this template
    or see https://jekyllrb.com/docs/liquid/tags/#links.
    using the scale attribute ![:scale 30%](...), you can adjust the image size.
-->

<!--  Adjust the day, month  -->
# 27 JUNE 2024

## INBO coding club

<!--  Adjust the room number and name  -->
Herman Teirlinck Building

01.70 - Ferdinand Peters

---
class: left, top

# Reminders

1. Did we confirm the room reservation on the _roomie_?
2. Did we start the recording?


---
class: center, middle

<!-- Create a new badge using Inkscape or other programs based on the assets/images/coding_club_badges.svg file -->
![:scale 90%]({{ site.baseurl}}/assets/images/20240627/20240627_badge_functional.png)

---
class: left, top

## Functional programming

There are 3 main programming paradigms: procedural programming, object-oriented programming and functional programming.

- Functional programming: _"wrap up for-loops in a function, and call that function instead of using the for-loop directly"_, [R for Data Science](https://r4ds.had.co.nz/iteration.html#for-loops-vs.functionals)

There are three best practices that you should generally follow*:

- Your functions should accept at least one argument.

- Your functions should return data, or another function.

- Don’t use loops! Loops declare a procedure = procedural programming

Do you know that you are doing functional programming everytime you use the pipes (`%>%` from tidyverse or the new `|>` from R 4.0)?

<small> __\* Source__: From blogpost [Functional Programming 101 -
A DEEP DIVE ON THE BENEFITS OF FUNCTIONAL PROGRAMMING AND WHY IT’S ACTUALLY EASIER THAN YOU THINK](https://github.com/readme/guides/functional-programming-basics).

---
class: left, top

## Functional programming and R

- R is basically a functional language: "_it lends itself to a style of problem solving centred on functions_"*.

- Functional programming in basic R: `apply()`, `lapply()`, `tapply()`.

- The [purrr](https://purrr.tidyverse.org) package provides a complete and consistent set of tools.

- The most important purrr function? `map()`!

<center>![:scale 30%]({{ site.baseurl}}/assets/images/20240627/20240627_purrr_logo.png)<br></center>


<small> __\* Source__: Nobody teaches R better than Hadley Wickham, I think. The chapter [**Functional programming**](https://adv-r.hadley.nz/fp.html#fp) from his great [Advanced R](https://adv-r.hadley.nz/index.html) book. A must reading for our summer!

---
class: left, top

## Functional programming: why?

But why doing functional programming?

Are purrr's functions or apply() functions faster than loops? Not necessarily! It's just another way of programming. And it's a question of clarity: **code is easier to write and to read**.

[Bjarne Stroustrup](https://en.wikipedia.org/wiki/Bjarne_Stroustrup), the developer of C++ programming language: "_To become significantly more reliable, code must become more transparent. In particular, nested conditions and loops must be viewed with great suspicion. Complicated control flows confuse programmers. Messy code often hides bugs._""

To "forget" loops and become a functional programmer, you need first a little of practice, and here we are: doing some purrr "fitness" exercises at the INBO coding _gym_ club.

---
class: left, top

## Functionals: the `map()` function

A **functional** is a function that takes a function as an input and returns a vector as output.

`apply()`, `lapply()`, `tapply()`, `map()`: they are all examples of **functionals**.


```r
plus_two <- function(x) x + 2
map(1:3, plus_two)
#> [[1]]
#> [1] 3
#>
#> [[2]]
#> [1] 4
#>
#> [[3]]
#> [1] 5
```

![:scale 70%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)
<br><small>Source: Hadley Wickham, https://adv-r.hadley.nz/functionals.html</small>

---
class: left, top

## The `map()` function

Why `map()` is called map? It refers to the math concept of _map_ or [_mapping_](https://en.wikipedia.org/wiki/Map_(mathematics)), which is quite a synonym of function, i.e. an operation that associates each element of a set with one or more elements of another set.

![:scale 70%]({{ site.baseurl}}/assets/images/20240627/20240627_Function_color_example_3.png)

<small> __\* Source__: by Function_color_example_3.gif: Wvbailey. The original uploader was Wvbailey at English Wikipedia.derivative work: Zerodamage - This file was derived from: Function color example 3.gif:, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=20802095

---
class: left, top

Install packages: (maybe not needed)

```r
install.packages("tidyverse")
```

Load the packages:

```r
library(tidyverse)
```

---
class: center, top

![:scale 100%]({{ site.baseurl}}/assets/images/20240627/20240627_purrr_cheat_sheet.png)<br>

Download and use the [purrr cheatsheet](https://github.com/inbo/coding-club/blob/main/cheat_sheets/20240425_cheat_sheet_purrr.pdf). [Online version](https://rstudio.github.io/cheatsheets/html/purrr.html) available as webpage. Also pdf in other 6 languages.

---
class: left, top

## How to get started?

Check the [Each session setup](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup) to get started.

## First time coding club?

Check the [First time setup](https://inbo.github.io/coding-club/gettingstarted.html#first-time-setup) section to setup.

---
class: left, top

![:scale 100%]({{ site.baseurl}}/assets/images/coding_club_sticky_concept.png)

---
class: center, top

# Share your code during the coding session

<!-- Create a new hackmd file and replace this link (twice!) -->
Go to https://hackmd.io/p2UZHhNaSgSG649TO3LgJg?edit and start by adding your name in section "Participants".

<iframe src="https://hackmd.io/p2UZHhNaSgSG649TO3LgJg?edit" height="450px" width="800px"></iframe>


---
class: left, top

# Download data and code

You can download the material of today:

- automatically via `inborutils::setup_codingclub_session()`*

- manually** from GitHub folders [/data/20240627](https://github.com/inbo/coding-club/tree/master/data/20240627) and [/src/20240627](https://github.com/inbo/coding-club/tree/master/src/20240627)

<br>
<small> __\* Note__: you can use the date in "YYYYMMDD" format to download the coding club material of a specific day, e.g. run `setup_codingclub_session("20220428")` to download the coding club material of April, 28 2022. If date is omitted, i.e. `setup_codingclub_session()`, the date of today is used. For all options, check the [tutorial online](https://inbo.github.io/tutorials/tutorials/r_setup_codingclub_session/).</small>
<br>
<small> __\*\* Note__: check the getting started instructions on [how to download a single file](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup)</small>

---
class: left, top

# Data and scripts description

## Data

- [swiss](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/swiss.html) and [iris](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/iris.html): two base R datasets.
- Datasets with sensor data: [20240627_sensor_A1.txt](https://github.com/inbo/coding-club/blob/master/data/20240627/20240627_sensor_A1.txt), [20240627_sensor_G7.txt](https://github.com/inbo/coding-club/blob/master/data/20240627/20240627_sensor_G7.txt), and [20240627_sensor_H4.txt](https://github.com/inbo/coding-club/blob/master/data/20240627/20240627_sensor_H4.txt)

## Scripts

- [20240627_challenges.R](https://github.com/inbo/coding-club/blob/main/src/20240627/20240627_challenges.R): R script to start with.

---
class: left, middle

# Basics: `map()`

The _mantra_ of this 2 hours coding session is: **FOR EACH __ OF __ APPLY FUNCTION __**

<p>![:scale 85%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</p>

---
class: left, top

# Challenge 0

<p><center>![:scale 50%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)
```
- FOR EACH element OF `height_giraffe` APPLY FUNCTION floor()
- FOR EACH element OF `height_giraffe` APPLY FUNCTION as.character()

Do we need `map()`?

---
class: left, top

# Challenge 0

<p><center>![:scale 50%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)

# weight of 5 giraffes
weight_giraffe <- rnorm(n = 5, mean = 1192, sd = 300)

# data.frame with height and weight
df_giraffe <- tibble(height = height_giraffe,
                     weight = weight_giraffe)
```

- FOR EACH column OF `df_giraffe` APPLY FUNCTION mean
- FOR EACH column OF `df_giraffe` APPLY FUNCTION median

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_1.png)
class: left, top

# Challenge 1

Write `map()` statements to:

1. Compute the mean of every column in `swiss` data.frame.
2. Determine the type of each column in  `iris` data.frame.
3. After creating the variable `list_wtih_dfs` as a named list with `swiss` and `iris` (code provided), compute the number of rows of each data.frame.
4. `map` returns ALWAYS a list, **ALWAYS**. Apply the right `map_*()` variants to the previous exercises to return a numeric vector (exercise 1), a character vector (exercise 2) or a data.frame (exercise 3). Hint: use cheat sheet or the sections https://adv-r.hadley.nz/functionals.html#map-atomic, https://r4ds.had.co.nz/iteration.html#the-map-functions.

---
class: left, top

# Intermezzo: passing (extra) arguments

Sometimes you need to pass extra arguments to the function you want to apply. Example: how to apply mean and median without taking into account NA values?

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)

# weight of 5 giraffes
weight_giraffe <- rnorm(n = 5, mean = 1192, sd = 300)

# there are some NAs
weight_giraffe[3] <- NA

# data.frame with height and weight
df_giraffe <- tibble(height = height_giraffe,
                     weight = weight_giraffe)
```

- FOR EACH column OF `df_giraffe` APPLY FUNCTION mean
- FOR EACH column OF `df_giraffe` APPLY FUNCTION median

Read more in section ["Passing arguments"](https://adv-r.hadley.nz/functionals.html#passing-arguments)

---
class: left, top

# Intermezzo: passing (extra) arguments

Sometimes a picture is worth a thousand words...

<p><center>![:scale 50%]({{ site.baseurl}}/assets/images/20240627/20240627_map-arg.png)</center></p>
<br><small>Source: Hadley Wickham, https://adv-r.hadley.nz/functionals.html#passing-arguments</small>

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_2.png)
class: left, top

# Challenge 2

So far so good. But data science is rarely so easy.

1. Read all sensor data files as a list of data.frames by applying the provided function `read_sensor_data()` to all the elements of the provided list `sensors` with sensor IDs. Hint: see intermezzo.

2. Calculate 10 random numbers from a normal distribution (`rnorm(n = 10)`) for each pair of the 4 provided mean and standard deviation and return it as a list of 4. Hint: [mapping-over-multiple-arguments](https://r4ds.had.co.nz/iteration.html#mapping-over-multiple-arguments)

3. Let's get back to our giraffes once again! <bold>FOR EACH </bold> giraffe OF list `info_giraffe` <bold>DO</bold> calculate the body mass index (weight / height^2). Both the function `bmi()` and the list `info_giraffe`*  are provided.

4. Get maximum and minimum datetime for all sensor data data.frames. Return them as a data.frame. This time you have to write your own function. Hint: write a function containing
```r
summarize(df, min_datetime = min(datetime), max_datetime = max(datetime))
```

<small> __\* Disclaimer__: any actual names of INBO colleagues are used in a fictitious manner. :-)


---
class: left, middle

# Intermezzo: `purrr` unleashed

Are you still hesitating about `purrr` potential? Well, check what `purrr` can do for your modelling work in the second page of the cheat sheet.

<p><center>![:scale 50%]({{ site.baseurl}}/assets/images/20200630/20200630_second_page_cheatsheet_purrr.png)</center></p>

1. Group your data
2. Nest it to create nested data.frames (column containing data.frames!)
3. Work with it (apply modelling as in cheat sheet or whatever else you have in mind)

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, middle

# Challenge 3

Let's play with [penguins](https://github.com/allisonhorst/palmerpenguins#palmerpenguins-) data! Group `penguins` data.frame by species and nest it as shown below:

```r
penguins %>%
  group_by(species) %>%
  nest()
# A tibble: 3 x 2
# Groups:   species [3]
  species   data
  <fct>     <list>
1 Adelie    <tibble [152 x 6]>
2 Gentoo    <tibble [124 x 6]>
3 Chinstrap <tibble [68 x 6]>
```

Add a column called  `plot` containing ggplot objects based on the geometry and aesthetics below:

```r
geom_point(aes(x = bill_length_mm ,
               y = bill_depth_mm,
               colour = sex))
```

<p><center>![:scale 10%]({{ site.baseurl}}/assets/images/20200630/20200630_palmer_penguins_data.png)</center></p>

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3

Do you know that dplyr offers some tools to apply selective functional programming?

1. FOR EACH column OF df_giraffe and class numeric, APPLY FUNCTION `floor()`
2. FOR EACH column OF df_giraffe ending with `ght` (height, weight), APPLY FUNCTION `floor()`

Hint: see vignette about [colum-wise operations](https://dplyr.tidyverse.org/articles/colwise.html).

---
class: left, top

# Bonus challenge

?group_map()

---
class: left, top

# The package of the month.



---
class: left, top

# Resources

- Challenges solutions and edited video recording will be available soon
- [purrr](https://r-spatial.github.io/sf/) package homepage.
- [purrr cheatsheet](https://rstudio.github.io/cheatsheets/html/purrr.html) webpage
- The [Advanced R](https://adv-r.hadley.nz/index.html) book of Hadley Wickham: the [Introduction](https://adv-r.hadley.nz/fp.html) to the chapter and the entire [chapter 9](https://adv-r.hadley.nz/functionals.html#functionals) about functional programming. This resource was extensively used to introduce the concepts and to write the challenges.


---
class: center, middle

Enjoy the summer! No INBO coding club in July!

---
class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!--  Adjust the room number and name  -->
Topic: to be decided <br>
Room:  HT - 01.21 - Jeanne Brabants <br>
Date: **27/08/2024**, from **10:00** to **12:30** <br>
Help needed with technical setup? You are welcom from **9:45am**
