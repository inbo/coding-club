---
layout: presentation
title: functional programming in R
---

class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!-- Do not forget to adapt the presentation title in the header! -->

<!-- Adjust the presentation to the session. Focus on the challenges,
    this is not a coding tutorial.

    Note, to include figures, store the image in the `/docs/assets/images/yyyymmdd/`
    folder and use the jekyll base.url reference as done in this template
    or see https://jekyllrb.com/docs/liquid/tags/#links.
    using the scale attribute ![:scale 30%](...), you can adjust the image size.
-->

<!--  Adjust the day, month  -->
# 27 JUNE 2024

## INBO coding club

<!--  Adjust the room number and name  -->
Herman Teirlinck Building

01.70 - Ferdinand Peters

---
class: left, top

# Reminders

1. Did we confirm the room reservation on the _roomie_?
2. Did we start the recording?


---
class: center, middle

<!-- Create a new badge using Inkscape or other programs based on the assets/images/coding_club_badges.svg file -->
![:scale 90%]({{ site.baseurl}}/assets/images/20240627/20240627_badge_functional.png)

---
class: left, top

## Functional programming

There are 3 main programming paradigms: procedural programming, object-oriented programming and functional programming.

- Functional programming: _"wrap up for-loops in a function, and call that a function instead of using the for-loop directly"_, [R for Data Science](https://r4ds.had.co.nz/iteration.html#for-loops-vs.functionals)

There are three best practices that you should generally follow*:

- Your functions should accept at least one argument.

- Your functions should return data, or another function.

- Don’t use loops! Loops declare a procedure = procedural programming

Do you know that you are doing functional programming everytime you use the pipes (`%>%` from tidyverse or the new `|>` from R 4.0)?

<small> __\* Source__: blogpost [Functional Programming 101 -
A DEEP DIVE ON THE BENEFITS OF FUNCTIONAL PROGRAMMING AND WHY IT’S ACTUALLY EASIER THAN YOU THINK](https://github.com/readme/guides/functional-programming-basics).

---
class: left, top

## Functional programming and R

- R is basically a functional language: "_it lends itself to a style of problem solving centred on functions_"*.

- Functional programming in basic R: `apply()`, `lapply()`, `tapply()`.

- The [purrr](https://purrr.tidyverse.org) package provides a complete and consistent set of tools.

- The most important purrr function? `map()`!

<center>![:scale 25%]({{ site.baseurl}}/assets/images/20240627/20240627_purrr_logo.png)<br></center>


<small> __\* Source__: Nobody teaches R better than Hadley Wickham, I think. The chapter [**Functional programming**](https://adv-r.hadley.nz/fp.html#fp) from his great [Advanced R](https://adv-r.hadley.nz/index.html) book. A must read for our summer!</small>

---
class: left, top

## Functional programming: why?

But why should you use functional programming?

Are purrr's functions or apply() functions faster than loops? Not necessarily! It's just another way of programming. And it's a question of clarity: **code is easier to write and to read**.

[Bjarne Stroustrup](https://en.wikipedia.org/wiki/Bjarne_Stroustrup), the developer of C++ programming language: "_To become significantly more reliable, code must become more transparent. In particular, nested conditions and loops must be viewed with great suspicion. Complicated control flows confuse programmers. Messy code often hides bugs._""

To "forget" loops and become a functional programmer, you first need a little practice, and here we are: our purrr workout at the INBO coding _gym_.

---
class: left, top

## Functionals: the `map()` function

A **functional** is a function that takes a function as an input and returns a vector as output.

`apply()`, `lapply()`, `tapply()`, `map()`: they are all examples of **functionals**.


```r
plus_two <- function(x) x + 2
map(1:3, plus_two)
#> [[1]]
#> [1] 3
#>
#> [[2]]
#> [1] 4
#>
#> [[3]]
#> [1] 5
```

<p><center>![:scale 20%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</center></p>
<br><small>Source: Hadley Wickham, https://adv-r.hadley.nz/functionals.html</small>

---
class: left, top

## The `map()` function

Why is `map()` called map? It refers to the math concept of _map_ or [_mapping_](https://en.wikipedia.org/wiki/Map_(mathematics), which is a synonym of function, i.e. an operation that associates each element of a set with one or more elements of another set.

![:scale 20%]({{ site.baseurl}}/assets/images/20240627/20240627_Function_color_example_3.png)

<small> __\* Source__: Function_color_example_3.gif: Wvbailey. The original uploader was Wvbailey at English Wikipedia.derivative work: Zerodamage - This file was derived from: Function color example 3.gif:, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=20802095</small>


---
class: left, top

## Webinars: solve iteration problems with purrr

Watch these two great videos (pdf slides are downloadable) about the talk given by Charlotte Wickham at the useR! International R User 2017 Conference: [part 1](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr/) and [part 2](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr-ii/).

<p><center>![:scale 90%]({{ site.baseurl}}/assets/images/20240627/20240627_webinars_CharlotteWickham.png)<br></center>


---
class: left, top

# Packages: install and load

Only tidyverse is used today. purrr is part of it.

```r
# if needed
install.packages("tidyverse")
```

Load the packages:

```r
library(tidyverse)
```

---
class: center, top

![:scale 90%]({{ site.baseurl}}/assets/images/20240627/20240627_purrr_cheat_sheet.png)<br>

Download and use the [purrr cheatsheet](https://github.com/inbo/coding-club/blob/main/cheat_sheets/20240627_cheat_sheet_purrr.pdf). [Online version](https://rstudio.github.io/cheatsheets/html/purrr.html) is available as a webpage, including the downloadable pdf in other 6 languages.

---
class: left, top

## How to get started?

Check the [Each session setup](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup) to get started.

## First time coding club?

Check the [First time setup](https://inbo.github.io/coding-club/gettingstarted.html#first-time-setup) section to setup.

---
class: left, top

![:scale 100%]({{ site.baseurl}}/assets/images/coding_club_sticky_concept.png)

---
class: center, top

# Share your code during the coding session

<!-- Create a new hackmd file and replace this link (twice!) -->
Go to https://hackmd.io/p2UZHhNaSgSG649TO3LgJg?edit and start by adding your name in section "Participants".

<iframe src="https://hackmd.io/p2UZHhNaSgSG649TO3LgJg?edit" height="450px" width="800px"></iframe>


---
class: left, top

# Download data and code

You can download the material of today:

- automatically via `inborutils::setup_codingclub_session()`*

- manually** from GitHub folders [/data/20240627](https://github.com/inbo/coding-club/tree/master/data/20240627) and [/src/20240627](https://github.com/inbo/coding-club/tree/master/src/20240627)

<br>
<small> __\* Note__: you can use the date in "YYYYMMDD" format to download the coding club material of a specific day, e.g. run `setup_codingclub_session("20220428")` to download the coding club material of April, 28 2022. If date is omitted, i.e. `setup_codingclub_session()`, the date of today is used. For all options, check the [tutorial online](https://inbo.github.io/tutorials/tutorials/r_setup_codingclub_session/).</small>
<br>
<small> __\*\* Note__: check the getting started instructions on [how to download a single file](https://inbo.github.io/coding-club/gettingstarted.html#each-session-setup)</small>

---
class: left, top

# Data and scripts description

## Data

- Datasets [swiss](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/swiss.html) and [iris](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/iris.html): two base R datasets.
- Datasets with sensor data: `20240627_sensor_A1.txt`, `20240627_sensor_G7.txt` and `20240627_sensor_H4.txt`.
- `20240627_lepidoptera_2024.tsv`: observations of Lepidoptera taken in 2024. Derived from: GBIF.org (22 May 2024) GBIF Occurrence Download https://doi.org/10.15468/dl.mnaffe.
- List containing the row numers of the GBIF observations in `20240627_lepidoptera_2024.tsv` falling in each of the Belgian Natura2000 protected areas. Provided as an R object: `20240627_lepidoptera_in_prot_areas.RData`.


## Scripts

- [20240627_challenges.R](https://github.com/inbo/coding-club/blob/main/src/20240627/20240627_challenges.R): R script to start with.

---
class: left, top

# Basics: `map()`

The _mantra_ of this 2 hours coding session is:

**FOR EACH** \_\_ **OF** \_\_ **APPLY FUNCTION** \_\_

<p>![:scale 60%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</p>

---
class: left, top

# Basics: `map()`

The _mantra_ of this 2 hours coding session is:

**FOR EACH** \_\_ **OF** \_\_ **APPLY FUNCTION** \_\_

<p>![:scale 70%]({{ site.baseurl}}/assets/images/20200630/20200630_map_basics.png)</p>

---
class: left, top

# Challenge 0

<p><center>![:scale 30%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)
```
- FOR EACH element OF `height_giraffe` APPLY FUNCTION floor()
- FOR EACH element OF `height_giraffe` APPLY FUNCTION as.character()

Do we need `map()`?

---
class: left, top

# Challenge 0

<p><center>![:scale 30%]({{ site.baseurl}}/assets/images/20240627/20240627_map.png)</center></p>

```r
# height of 5 giraffes
height_giraffe <- runif(n = 5, min = 4.3, max = 5.7)

# weight of 5 giraffes
weight_giraffe <- rnorm(n = 5, mean = 1192, sd = 300)

# data.frame with height and weight
df_giraffe <- tibble(height = height_giraffe,
                     weight = weight_giraffe)
```

- FOR EACH column OF `df_giraffe` APPLY FUNCTION mean
- FOR EACH column OF `df_giraffe` APPLY FUNCTION median

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_1.png)
class: left, top

# Challenge 1

Write `map()` statements to:

1. Compute the mean of every column in the `swiss` data.frame.
2. Determine the type of each column in the `iris` data.frame.
3. After creating the variable `list_with_dfs` as a named list with `swiss` and `iris` (code provided), compute the number of rows of each data.frame.
4. `map()` ALWAYS returns a list, **ALWAYS**. Apply the right `map_*()` variants to the previous exercises to return a numeric vector (exercises 1 and 3), a character vector (exercise 2) or a data.frame (exercises 1, 2 and 3). Hint: use cheat sheet or the sections [map-atomic](https://adv-r.hadley.nz/functionals.html#map-atomic) and [the-map-functions](https://r4ds.had.co.nz/iteration.html#the-map-functions).

---
class: left, top

# Intermezzo: the `map` strategy

So far so good. But data science is rarely so easy.

We use again our giraffes*, this time as a list:

```r
# Height of 5 giraffes
height_giraffe <- runif(n = 6, min = 4.3, max = 5.7)
# Weight of 5 giraffes
weight_giraffe <- rnorm(n = 6, mean = 1192, sd = 300)
# GPS tracker ID
gps_tracker_giraffe <- c("A31", "E4T", "RT4", "YU7", "3G1", "ON9")
# Giraffes nicknames
nicknames_giraffe <- sample(
  c("Amber", "Damiano", "Dirk", "Emma", "Raïsa", "Rhea")
)
# List with weight, height and GPS tracker IDs. Use nicknames as list element names.
giraffes <- tibble::tibble("weight" = weight_giraffe,
                           "height" = height_giraffe,
                           "gpsID" = gps_tracker_giraffe) %>%
  transpose %>%
  set_names(nicknames_giraffe)
giraffes
```

<small> __\* Disclaimer__: any actual names of INBO colleagues are used in a fictitious manner :-)</small>

---
class: left, top

# Intermezzo: the `map` strategy

<p>Example: <bold>FOR EACH</bold> giraffe OF giraffes <bold>DO APPLY </bold> bmi function (weight / height^2)</p>

```r
bmi <- function(weight, height) weight / height^2
```

But:

```r
map(giraffe, bmi)
Error in `map()`:
ℹ In index: 1.
ℹ With name: Amber.
Caused by error in `.f()`:
! argument "height" is missing, with no default
```

---
class: left, top

## Intermezzo: the `map` strategy

1. Do it for one element
2. Turn it into a <bold>recipe</bold>
3. Use `map()` to apply it to all elements


### 1. Do it for one element

```r
amber <- giraffes$Amber
bmi(amber$weight, amber$height)
```

---
class: left, top

## Intermezzo: the `map` strategy

### 2. Turn it into a recipe

Abstract it so that Amber can be Damiano, Dirk or any other giraffe. How to do so? Functions, again!

Define a (anonymous) function around it:
```r
function(x) bmi(x$weight, x$height)
```

Alternative way (see cheat sheet) in "modern R" (R 4.0 or higher):
```r
\(x) bmi(x$weight, x$height)
```

Old school, with triddle `~` and `.x` pronoun. It works perfectly, but maybe less readable:
```r
~ bmi(.x$weight, .x$height)
```

Or, you can give a name to this function! It's not anonymous anymore.
```r
bmi_giraffe <- function(x) bmi(x$weight, x$height)
```

---
class: left, top

## Intermezzo: the `map` strategy

### 3. Use `map()` to apply it to all elements

Via anonymous function:
```r
map(giraffes, function(x) bmi(x$weight, x$height))
```

Or if you defined the function `bmi_giraffe`:
```r
map(giraffes, bmi_giraffe)
```

Or via shortcut, new or old way:
```r
map(giraffes, \(x) bmi(x$weight, x$height))
map(giraffes, ~ bmi(.x$weight, .x$height))
```

Finally, you do not need stick with x. Sometimes it is better to give a more meaningful name:
```
map(giraffes, function(giraffe) bmi(giraffe$weight, giraffe$height))
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_2.png)
class: left, top

# Challenge 2

1. Read all sensor data files as a list of data.frames by applying the provided function `read_sensor_data()` to all the elements of the provided list `sensors` with sensor IDs.

2. Now, you want to generalize your script. You rewrite `read_sensor_data()` as provided in the code. How to apply map in this situation? Notice that your path and extensions are constants. Hint: see https://adv-r.hadley.nz/functionals.html#passing-arguments.

3. Calculate 10 random numbers from a normal distribution (`rnorm(n = 10)`) for each pair of the 4 provided means and standard deviations and return it as a list of 4. Hint: [mapping-over-multiple-arguments](https://r4ds.had.co.nz/iteration.html#mapping-over-multiple-arguments)

4. Get maximum and minimum datetime for all sensor data data.frames. Return them as a data.frame. This time you have to write your own function. Hint: write a function containing:
```r
summarize(df, min_datetime = min(datetime), max_datetime = max(datetime))
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3

Nothing better than using the result of a previous coding club as a starting point for a challenge!

In challenge 3.1 of the May session, we created a list with the (row numbers of the) lepidoptera observations taken in protected areas.

```
> lepidoptera_in_prot_areas
Sparse geometry binary predicate list of length 310, where the predicate was `contains'
first 10 elements:
 1: (empty)
 2: (empty)
 3: 233, 241, 259, 302, 306, 320, 461, 488, 498, 501, ...
 4: (empty)
 5: 547, 549
 6: (empty)
 7: (empty)
 8: 217, 235, 283, 412, 826
 9: (empty)
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3A

1. The typical next step is: how many observations for ech protected areas? purr can help us, of course.
2. Given `obs`, the data.frame with the GBIF observations (see the provided code), how to get a data.frame with only the observations taken in protected areas?
3. purrr is more than the `map` family. To join the data.frames `species_1`, `species_2` and `species_3` (code provided) you could apply `full_join()` twice:
```r
full_join(species_1, species_2, by = "species") %>%
  full_join(species_3, by = "species")
```
But this is definitely not DRY and prone to errors! Try to do it DRY by using lists and purrr. Hint: try function `reduce()`, second page of the cheat sheet.

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3B - a little of dplyr

Do you know that dplyr offers some tools which are basically functional programming?

```r
# Height of 5 giraffes
height_giraffe <- runif(n = 6, min = 4.3, max = 5.7)
# Weight of 5 giraffes
weight_giraffe <- rnorm(n = 6, mean = 1192, sd = 300)
# GPS tracker ID
gps_tracker_giraffe <- c("A31", "E4T", "RT4", "YU7", "3G1", "ON9")
# Giraffes nicknames
nicknames_giraffe <- sample(
  c("Amber", "Damiano", "Dirk", "Emma", "Raïsa", "Rhea")
)
# Data.frame with weight, height and GPS tracker IDs.
df <- tibble::tibble(
  "weight" = weight_giraffe,
  "height" = height_giraffe,
  "gpsID" = gps_tracker_giraffe
)
```

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Challenge 3B - a little of dplyr (continued)

Write the code to solve the following pseudo code:

1. FOR EACH column OF df and class numeric, APPLY FUNCTION `floor()`. Modify the columns.

2. FOR EACH column OF df ending with `ight` (height, weight), APPLY FUNCTION `floor()`. Modify the columns. Same result of exercise 1 expected.

3. Instead of modifying the columns, how to add new ones?

Hint: see vignette about [colum-wise operations](https://dplyr.tidyverse.org/articles/colwise.html).

---
class: left, top

# Bonus challenge: purrr + tidyr = power

Are you still hesitating about the potential of `purrr`? You still don't know what it can do in combination with tidyr! They can really do a lot for making your modelling research a lot more understandable for (future) you and all your colleagues. Check the second page of the tidyr cheat sheet.

<p><center>![:scale 40%]({{ site.baseurl}}/assets/images/20240627/20240627_second_page_cheatsheet_tidyr.png)</center></p>

1. Group your data
2. Nest it to create nested data.frames (column containing data.frames, aka **list-columns**)
3. Work with it (apply modelling as in cheat sheet or whatever else you have in mind)

---
background-image: url({{ site.baseurl}}/assets/images/background_challenge_3.png)
class: left, top

# Bonus challenge: purrr + tidyr = power

Let's play with [penguins](https://github.com/allisonhorst/palmerpenguins#palmerpenguins) data! Group `penguins` data.frame by species and nest it as shown below:

```r
penguins %>%
  group_by(species) %>%
  nest()
# A tibble: 3 x 2
# Groups:   species [3]
  species   data
  <fct>     <list>
1 Adelie    <tibble [152 x 6]>
2 Gentoo    <tibble [124 x 6]>
3 Chinstrap <tibble [68 x 6]>
```

1. Add a column called  `plot` containing ggplot objects based on the geometry and aesthetics below:
```r
geom_point(aes(x = bill_length_mm ,
               y = bill_depth_mm,
               colour = sex))
```
2. Save the created plots using species name and extension `png`. Hint: https://r4ds.had.co.nz/iteration.html#walk


**Note**: this challenge requires basic plotting knowledge, e.g. [ggplot2](https://ggplot2.tidyverse.org/reference/).

---
class: left, top

# The package of the month. Damiano's choice

Are you bored to see and use `iris` everywhere to test code? I am. Why not using something else? Why not using penguins?!? The package [palmerpenguins](https://allisonhorst.github.io/palmerpenguins/) provide a great dataset for data exploration & visualization. A valid alternative to `iris`!

<p><center>![:scale 85%]({{ site.baseurl}}/assets/images/20240627/20240627_palmerpenguins_homepage.png)


---
class: left, top

# Resources

- [Challenges solutions](https://github.com/inbo/coding-club/blob/main/src/20240627/20240627_challenges_solutions.R) are available. You can opt to download them by using `inborutils::setup_codingclub_session("20240627")`.
- Edited video recording is available on [vimeo](https://vimeo.com/984798654).
- [purrr](https://r-spatial.github.io/sf/) package homepage.
- [purrr cheatsheet](https://rstudio.github.io/cheatsheets/html/purrr.html) webpage
- Download the [purrr cheatsheet]() from our repository
- The [Advanced R](https://adv-r.hadley.nz/index.html) book of Hadley Wickham: the [Introduction](https://adv-r.hadley.nz/fp.html) to the chapter and the entire [chapter 9](https://adv-r.hadley.nz/functionals.html#functionals) about functional programming. This resource was extensively used to introduce the concepts and inspired some challenges.
- Well-written and complete tutorial: https://r4ds.had.co.nz/iteration.html#for-loops-vs.functionals (from 21.4 up to 21.9)
- Beautiful webinar (pdf slides are downloadable) from Charlotte Wickham: [part 1](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr/) and [part 2](https://learn.microsoft.com/en-us/shows/user-international-r-user-conferences-user-international-r-user-2017-conference/solving-iteration-problems-purrr-ii/). Introduction to `map()` and the map strategy material come from her.
- The package [palmerpenguins](https://allisonhorst.github.io/palmerpenguins/) which offers a valid alternative to `iris` to test your data wrangling and data visualization code.
- [furrr](https://furrr.futureverse.org/) package homepage for _parallel_ functional programming.


---
class: center, middle

Enjoy the summer and solve the Word Search. No INBO coding club in July!

![:scale 50%]({{ site.baseurl}}/assets/images/20240627/20240627_SUMMER_HOLIDAYS_399189.png)
<br><small>Source: https://wordmint.com/public_puzzles/399189</small>

---
class: center, middle

![:scale 30%]({{ site.baseurl}}/assets/images/coding_club_logo_1.png)

<!--  Adjust the room number and name  -->
Topic: to be decided <br>
Room:  HT - 01.21 - Jeanne Brabants <br>
Date: **27/08/2024**, from **10:00** to **12:30** <br>
Help needed with technical setup? You are welcom from **9:45am**
